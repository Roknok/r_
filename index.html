<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ripple Screen</title>

<style>
html,body{
    margin:0;
    padding:0;
    overflow:hidden;
    height:100%;
    background:black;
}
canvas{
    display:block;
    touch-action:none;
}
#secret{
    position:fixed;
    bottom:10px;
    right:15px;
    color:blue;
    font-family:Arial;
    font-size:14px;
    cursor:pointer;
}
</style>
</head>
<body>

<canvas id="c"></canvas>
<div id="secret">dont click here</div>

<script>

var c = document.getElementById("c");
var ctx = c.getContext("2d", { alpha:false });

var w = 0;
var h = 0;

var buf1 = null;
var buf2 = null;

var img1 = new Image();
var img2 = new Image();

img1.src = "image.jpg";
img2.src = "image.png";

var activeImage = img1;

var srcC = document.createElement("canvas");
var srcCtx = srcC.getContext("2d");

var bg = "rgb(200,225,255)";

// RIPPLE COOLDOWN (200ms = 5 per second)
var lastRippleTime = 0;
var rippleDelay = 200;

function resizeCanvas(){
    c.width = window.innerWidth;
    c.height = window.innerHeight;

    w = c.width;
    h = c.height;

    if(activeImage.complete){
        start(activeImage);
    }
}

window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function start(imgObj){

    if(!w || !h) return;

    var scale = Math.min(w / imgObj.width, h / imgObj.height);
    var iw = imgObj.width * scale;
    var ih = imgObj.height * scale;

    var x = (w - iw) / 2;
    var y = (h - ih) / 2;

    srcC.width = w;
    srcC.height = h;

    srcCtx.fillStyle = bg;
    srcCtx.fillRect(0,0,w,h);

    srcCtx.drawImage(imgObj, x, y, iw, ih);

    buf1 = new Int32Array(w*h);
    buf2 = new Int32Array(w*h);

    ctx.drawImage(srcC,0,0);
}

img1.onload = function(){
    start(img1);
};

function getCanvasCoords(clientX, clientY){
    var rect = c.getBoundingClientRect();
    var scaleX = c.width / rect.width;
    var scaleY = c.height / rect.height;

    return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
    };
}

function splash(mx,my){

    var now = Date.now();

    // cooldown check
    if(now - lastRippleTime < rippleDelay){
        return;
    }

    lastRippleTime = now;

    if(!buf1) return;

    mx = Math.floor(mx);
    my = Math.floor(my);

    for(var yy=-10; yy<10; yy++){
        for(var xx=-10; xx<10; xx++){

            var px = mx + xx;
            var py = my + yy;

            if(px>1 && px<w-1 && py>1 && py<h-1){
                buf1[py*w + px] = 2000;
            }
        }
    }
}

c.addEventListener("pointerdown", function(e){
    var pos = getCanvasCoords(e.clientX, e.clientY);
    splash(pos.x, pos.y);
});

c.addEventListener("pointermove", function(e){
    if(e.buttons){
        var pos = getCanvasCoords(e.clientX, e.clientY);
        splash(pos.x, pos.y);
    }
});

function loop(){

    if(!buf1 || !buf2 || buf1.length !== w*h){
        requestAnimationFrame(loop);
        return;
    }

    var imgData = srcCtx.getImageData(0,0,w,h);
    var pixels = imgData.data;

    for(var y=1; y<h-1; y++){
        for(var x=1; x<w-1; x++){

            var i = y*w + x;

            buf2[i] = (
                buf1[i-1] +
                buf1[i+1] +
                buf1[i-w] +
                buf1[i+w]
            )/2 - buf2[i];

            buf2[i] *= 0.98;

            var dx = (buf2[i-1] - buf2[i+1]) / 12;
            var dy = (buf2[i-w] - buf2[i+w]) / 12;

            var sx = x + dx;
            var sy = y + dy;

            if(sx<0) sx=0;
            if(sx>=w) sx=w-1;
            if(sy<0) sy=0;
            if(sy>=h) sy=h-1;

            var si = (Math.floor(sy)*w + Math.floor(sx))*4;
            var di = i*4;

            if(si >= 0 && si+2 < pixels.length){
                pixels[di]     = pixels[si];
                pixels[di + 1] = pixels[si + 1];
                pixels[di + 2] = pixels[si + 2];
            }
        }
    }

    ctx.putImageData(imgData,0,0);

    var temp = buf1;
    buf1 = buf2;
    buf2 = temp;

    requestAnimationFrame(loop);
}

requestAnimationFrame(loop);

document.getElementById("secret").addEventListener("click", function(){

    if(activeImage === img1){
        activeImage = img2;
    } else {
        activeImage = img1;
    }

    start(activeImage);
});

</script>

</body>
</html>
